<template>
    <f-menu
        :modelValue="activePath"
        :expandedKeys="defaultExpandMenu"
        :inverted="inverted"
        :mode="mode"
        :options="transformedMenus"
        :defaultExpandAll="defaultExpandAll"
        :accordion="accordion"
        @select="onMenuClick"
    ></f-menu>
</template>

<script>
import { computed, h } from 'vue';
import { FMenu } from '@fesjs/fes-design';
import { useRoute, useRouter } from '@@/core/coreExports';
import { transform as transformByAccess } from '../helpers/pluginAccess';
import { transform as transformByLocale } from '../helpers/pluginLocale';
import { flatNodes } from '../helpers/utils';
import MenuIcon from './MenuIcon.vue';

const transform = (menus) =>
    menus.map((menu) => {
        const copy = {
            ...menu,
            label: menu.title,
            value: menu.path || Date.now(),
        };
        if (menu.icon) {
            copy.icon = () =>
                h(MenuIcon, {
                    icon: menu.icon,
                });
        }
        if (menu.children) {
            copy.children = transform(menu.children);
        }
        return copy;
    });

export default {
    components: {
        FMenu,
    },
    props: {
        menus: {
            type: Array,
            default() {
                return [];
            },
        },
        mode: {
            type: String,
            default: 'vertical',
        },
        inverted: {
            type: Boolean,
            default: false,
        },
        expandedKeys: {
            type: Array,
            default() {
                return [];
            },
        },
        defaultExpandAll: {
            type: Boolean,
            default: false,
        },
        accordion: {
            type: Boolean,
            default: false,
        },
    },
    setup(props) {
        const route = useRoute();
        const router = useRouter();
        const transformedMenus = computed(() => transformByLocale(transformByAccess(transform(props.menus))));
        const menuArray = computed(() => flatNodes(transformedMenus.value));
        const activePath = computed(() => {
            const matchMenus = menuArray.value.filter((menu) => {
                const match = menu.match;
                if (!match || !Array.isArray(match)) {
                    return false;
                }
                return match.some((str) => {
                    const reg = new RegExp(str);
                    return reg.test(route.path);
                });
            });
            if (matchMenus.length === 0) {
                return route.path;
            }
            return matchMenus[0].path;
        });
        const defaultExpandMenu = computed(() => {
            let index = menuArray.value.findIndex((item) => item.value === activePath.value);
            const activeMenu = menuArray.value[index];
            const arr = [activeMenu];
            while (index > 0) {
                index = index - 1;
                const lastMenu = menuArray.value[index];
                if (lastMenu.children && lastMenu.children.indexOf(arr[arr.length - 1]) !== -1) {
                    arr.push(lastMenu);
                }
            }
            return props.expandedKeys.concat(arr.map((item) => item.value));
        });
        const onMenuClick = (e) => {
            const path = e.value;
            if (/^https?:\/\//.test(path)) {
                window.open(path, '_blank');
            } else if (/^\//.test(path)) {
                router.push(path);
            } else {
                console.warn('[plugin-layout]: 菜单的path只能使以http(s)开头的网址或者路由地址');
            }
        };
        return {
            activePath,
            defaultExpandMenu,
            transformedMenus,
            onMenuClick,
        };
    },
};
</script>
